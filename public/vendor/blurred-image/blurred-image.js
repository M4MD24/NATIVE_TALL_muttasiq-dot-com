(()=>{var V=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","#","$","%","*","+",",","-",".",":",";","=","?","@","[","]","^","_","{","|","}","~"],y=t=>{let e=0;for(let i=0;i<t.length;i++){let a=t[i],s=V.indexOf(a);e=e*83+s}return e},w=(t,e)=>{var i="";for(let a=1;a<=e;a++){let s=Math.floor(t)/Math.pow(83,e-a)%83;i+=V[Math.floor(s)]}return i},f=t=>{let e=t/255;return e<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)},g=t=>{let e=Math.max(0,Math.min(1,t));return e<=.0031308?Math.trunc(e*12.92*255+.5):Math.trunc((1.055*Math.pow(e,.4166666666666667)-.055)*255+.5)},_=t=>t<0?-1:1,b=(t,e)=>_(t)*Math.pow(Math.abs(t),e),E=class extends Error{constructor(t){super(t),this.name="ValidationError",this.message=t}},C=t=>{if(!t||t.length<6)throw new E("The blurhash string must be at least 6 characters");let e=y(t[0]),i=Math.floor(e/9)+1,a=e%9+1;if(t.length!==4+2*a*i)throw new E(`blurhash length mismatch: length is ${t.length} but it should be ${4+2*a*i}`)};var P=t=>{let e=t>>16,i=t>>8&255,a=t&255;return[f(e),f(i),f(a)]},A=(t,e)=>{let i=Math.floor(t/361),a=Math.floor(t/19)%19,s=t%19;return[b((i-9)/9,2)*e,b((a-9)/9,2)*e,b((s-9)/9,2)*e]},G=(t,e,i,a)=>{C(t),a=a|1;let s=y(t[0]),l=Math.floor(s/9)+1,d=s%9+1,m=(y(t[1])+1)/166,n=new Array(d*l);for(let r=0;r<n.length;r++)if(r===0){let h=y(t.substring(2,6));n[r]=P(h)}else{let h=y(t.substring(4+r*2,6+r*2));n[r]=A(h,m*a)}let o=e*4,u=new Uint8ClampedArray(o*i);for(let r=0;r<i;r++)for(let h=0;h<e;h++){let c=0,p=0,I=0;for(let M=0;M<l;M++)for(let v=0;v<d;v++){let H=Math.cos(Math.PI*h*v/e)*Math.cos(Math.PI*r*M/i),R=n[v+M*d];c+=R[0]*H,p+=R[1]*H,I+=R[2]*H}let k=g(c),q=g(p),B=g(I);u[4*h+0+r*o]=k,u[4*h+1+r*o]=q,u[4*h+2+r*o]=B,u[4*h+3+r*o]=255}return u},x=G,L=4,z=(t,e,i,a)=>{let s=0,l=0,d=0,m=e*L;for(let o=0;o<e;o++){let u=L*o;for(let r=0;r<i;r++){let h=u+r*m,c=a(o,r);s+=c*f(t[h]),l+=c*f(t[h+1]),d+=c*f(t[h+2])}}let n=1/(e*i);return[s*n,l*n,d*n]},U=t=>{let e=g(t[0]),i=g(t[1]),a=g(t[2]);return(e<<16)+(i<<8)+a},$=(t,e)=>{let i=Math.floor(Math.max(0,Math.min(18,Math.floor(b(t[0]/e,.5)*9+9.5)))),a=Math.floor(Math.max(0,Math.min(18,Math.floor(b(t[1]/e,.5)*9+9.5)))),s=Math.floor(Math.max(0,Math.min(18,Math.floor(b(t[2]/e,.5)*9+9.5))));return i*19*19+a*19+s},O=(t,e,i,a,s)=>{if(a<1||a>9||s<1||s>9)throw new E("BlurHash must have between 1 and 9 components");if(e*i*4!==t.length)throw new E("Width and height must match the pixels array");let l=[];for(let r=0;r<s;r++)for(let h=0;h<a;h++){let c=h==0&&r==0?1:2,p=z(t,e,i,(I,k)=>c*Math.cos(Math.PI*h*I/e)*Math.cos(Math.PI*r*k/i));l.push(p)}let d=l[0],m=l.slice(1),n="",o=a-1+(s-1)*9;n+=w(o,1);let u;if(m.length>0){let r=Math.max(...m.map(c=>Math.max(...c))),h=Math.floor(Math.max(0,Math.min(82,Math.floor(r*166-.5))));u=(h+1)/166,n+=w(h,1)}else u=1,n+=w(0,1);return n+=w(U(d),4),m.forEach(r=>{n+=w($(r,u),2)}),n},T=O;var S={x:4,y:3},D={width:32,height:32},F=new Map,j=t=>{if(F.has(t))return F.get(t);let e=fetch(t,{cache:"no-store"}).then(i=>{if(!i.ok)throw new Error(`[blurred-image] failed to fetch ${t}`);return i.blob()}).then(i=>URL.createObjectURL(i));return F.set(t,e),e},W=t=>new Promise((e,i)=>{let a=new Image;a.onload=()=>e(a),a.onerror=(...s)=>i(s),a.crossOrigin="Anonymous",a.src=t}),J=t=>{let e=document.createElement("canvas");e.width=t.width,e.height=t.height;let i=e.getContext("2d");if(!i)throw new Error("[blurred-image] could not get canvas context");return i.drawImage(t,0,0),i.getImageData(0,0,t.width,t.height)},K=async t=>{let e=await W(t),i=J(e);return T(i.data,i.width,i.height,S.x,S.y)},N=(t,e)=>{let i=x(t,D.width,D.height),a=e.getContext("2d");a&&a.putImageData(new ImageData(i,D.width,D.height),0,0)};document.addEventListener("alpine:init",()=>{window.Alpine.data("blurredImage",t=>({thumbnailLink:t.thumbnailLink,link:t.link,element:t.element,fallbackLink:t.fallbackLink,isEagerLoaded:t.isEagerLoaded,isDisplayEnforced:t.isDisplayEnforced,imageDecoded:!1,imgLoaded:!1,imageFailed:!1,visible:!1,imageRequested:!1,imageSrc:null,finalVisible:!1,revealStarted:!1,blurhashReady:!1,blurhashFailed:!1,grayHoldDone:!1,blurhashHoldDone:!1,blurhashHoldTimer:null,showGray:!0,showBlurhash:!1,showImage:!1,fullIntersectFeasible:!0,fullIntersectSafetyMargin:96,resizeHandler:null,hashReadyEventDispatched:!1,revealEventDispatched:!1,init(){this.startGrayHold(),this.visible=this.isDisplayEnforced,this.evaluateFullIntersectionFeasibility(),this.resizeHandler=()=>this.evaluateFullIntersectionFeasibility(),window.addEventListener("resize",this.resizeHandler,{passive:!0}),this.$nextTick(()=>{this.generateBlurImage(this.thumbnailLink,this.element),(this.isDisplayEnforced||this.isEagerLoaded)&&this.requestImage()})},getTestIdForEvent(){var i,a,s,l,d;let e=(i=this.element)==null?void 0:i.closest("[data-testid]");return(a=e==null?void 0:e.dataset)!=null&&a.testid?e.dataset.testid:(d=(l=(s=this.element)==null?void 0:s.dataset)==null?void 0:l.testid)!=null?d:null},dispatchTestEvent(e,i={}){if(!this.element)return;let a={testId:this.getTestIdForEvent(),...i};a.testId&&typeof window!="undefined"&&(window.__blurredImageTestSignals=window.__blurredImageTestSignals||{},window.__blurredImageTestSignals[a.testId]=window.__blurredImageTestSignals[a.testId]||{},window.__blurredImageTestSignals[a.testId][e]=a),this.element.dispatchEvent(new CustomEvent(e,{bubbles:!0,detail:a}))},dispatchHashReadyEvent(){this.hashReadyEventDispatched||(this.hashReadyEventDispatched=!0,this.dispatchTestEvent("blurred-image:hash-ready",{blurhashReady:this.blurhashReady,blurhashFailed:this.blurhashFailed}))},dispatchRevealEvent(){this.revealEventDispatched||(this.revealEventDispatched=!0,this.dispatchTestEvent("blurred-image:revealed",{imageRequested:this.imageRequested,imageSrc:this.imageSrc,imageFailed:this.imageFailed,showImage:this.showImage,finalVisible:this.finalVisible}))},generateBlurImage:async function(e,i){try{let a=await K(e),s=i.querySelector("canvas");s instanceof HTMLCanvasElement?(N(a,s),this.blurhashReady=!0,this.startBlurhashHold()):(this.blurhashFailed=!0,this.startBlurhashHold()),this.dispatchHashReadyEvent(),this.updateVisibility()}catch(a){console.warn("[blurred-image] blurhash failed, falling back",a),this.blurhashFailed=!0,this.dispatchHashReadyEvent(),this.startBlurhashHold(),this.updateVisibility()}},startGrayHold:function(){window.setTimeout(()=>{this.grayHoldDone=!0,this.updateVisibility()},200)},startBlurhashHold:function(){this.blurhashHoldTimer||(this.blurhashHoldTimer=window.setTimeout(()=>{this.blurhashHoldDone=!0,this.updateVisibility()},600))},markVisible:function(e){if(this.isDisplayEnforced){this.visible=!0,this.updateVisibility(),this.requestImage();return}if(e){this.visible=!0,this.requestImage(),this.updateVisibility();return}this.finalVisible||(this.visible=!1,this.updateVisibility())},handlePartialEnter:function(){this.evaluateFullIntersectionFeasibility(),this.fullIntersectFeasible||this.markVisible(!0)},evaluateFullIntersectionFeasibility:function(){var a,s,l;let e=(s=(a=this.element)==null?void 0:a.getBoundingClientRect().height)!=null?s:0,i=(l=window.innerHeight)!=null?l:0;this.fullIntersectFeasible=e+this.fullIntersectSafetyMargin<=i},markLoaded:function(){this.imgLoaded=!0,this.updateVisibility()},handleImageError:function(e){var i;if(this.imageFailed&&((i=e==null?void 0:e.target)==null?void 0:i.src)===this.fallbackLink){this.markLoaded();return}if(this.imageFailed=!0,e!=null&&e.target&&e.target.src!==this.fallbackLink){e.target.src=this.fallbackLink;return}this.markLoaded()},requestImage:function(){this.imageRequested||!this.link||(this.imageRequested=!0,j(this.link).then(e=>{this.imageDecoded=!0,this.imageSrc=e,this.updateVisibility()}).catch(e=>{console.warn("[blurred-image] request failed",e),F.delete(this.link),this.imageFailed=!0,this.imageDecoded=!0,this.imageSrc=this.fallbackLink,this.updateVisibility()}))},updateVisibility:function(){this.showGray=!this.grayHoldDone||!this.blurhashReady&&!this.blurhashFailed,this.showBlurhash=this.blurhashReady&&this.grayHoldDone&&!this.revealStarted;let e=this.imgLoaded||this.imageFailed,i=this.visible||this.isDisplayEnforced||this.isEagerLoaded,a=!this.revealStarted&&(this.blurhashReady||this.blurhashFailed)&&this.blurhashHoldDone&&e&&(this.visible||this.isDisplayEnforced);!this.imageRequested&&i&&this.requestImage(),a&&(this.revealStarted=!0,this.finalVisible=!0,this.showGray=!1,this.showImage||(this.showImage=!0),this.dispatchRevealEvent(),window.requestAnimationFrame(()=>{this.showBlurhash=!1}))}}))});})();
